<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatbot</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 250px;
            background-color: #f4f4f4;
            border-right: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
        }

        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        #chat-output {
            flex-grow: 1;
            width: 100%;
            resize: none;
            padding: 10px;
            margin-bottom: 10px;
        }

        #chat-input {
            width: 80%;
            padding: 8px;
        }

        #send-button {
            padding: 8px 16px;
        }

        .chat-entry {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        .chat-entry:hover {
            background-color: #eaeaea;
        }

        .timestamp {
            font-size: 0.8em;
            color: gray;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            margin-top: 4px;
        }

        button.small {
            font-size: 0.75em;
            padding: 2px 6px;
        }

        #logout-link {
            margin-top: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Chat History</h3>
        <div id="history"></div>
        <a id="logout-link" href="{{ url_for('logout') }}">Logout</a>
    </div>

    <div id="main">
        <h2>Welcome, {{ username }}!</h2>
        <textarea id="chat-output" readonly></textarea>
        <div>
            <input type="text" id="chat-input" placeholder="Type your message..." />
            <button id="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

<script>
    let chatHistory = [];

   async function loadChatHistory() {
    try {
        const response = await fetch('/chat/history');
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        const data = await response.json();
        chatHistory = data.map(msg => ({
            id: msg._id,  // Now using string ID
            user: msg.message,
            bot: msg.bot_response,
            time: new Date(msg.timestamp).toLocaleString()
        }));
        renderChatOutput();
        renderSidebar();
    } catch (error) {
        console.error("Failed to load chat history:", error);
        document.getElementById('chat-output').value = "Error loading chat history. Please try again later.";
    }
}

    async function sendMessage() {
        const inputBox = document.getElementById('chat-input');
        const message = inputBox.value.trim();
        if (!message) return;

        try {
            const response = await fetch('/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            if (response.ok) {
                inputBox.value = '';
                await loadChatHistory();  // Refresh after sending
            } else {
                console.error("Failed to send message");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    function renderChatOutput() {
        const outputBox = document.getElementById('chat-output');
        outputBox.value = chatHistory.map(e => `You: ${e.user}\nBot: ${e.bot}\n`).join("\n\n");
    }

    function renderSidebar() {
        const sidebar = document.getElementById('history');
        sidebar.innerHTML = '';

        chatHistory.forEach((entry, index) => {
            const div = document.createElement('div');
            div.className = 'chat-entry';

            const content = document.createElement('div');
            content.textContent = entry.user;

            const time = document.createElement('div');
            time.className = 'timestamp';
            time.textContent = entry.time;

            const actions = document.createElement('div');
            actions.className = 'chat-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'small';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => {
                const newMsg = prompt("Edit your message:", entry.user);
                if (newMsg !== null && newMsg.trim() !== '') {
                    updateMessage(entry.id, newMsg.trim());
                }
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'small';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => {
                deleteMessage(entry.id);
            };

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            div.appendChild(content);
            div.appendChild(time);
            div.appendChild(actions);
            sidebar.appendChild(div);
        });
    }

    async function deleteMessage(id) {
        try {
            const response = await fetch(`/chat/delete/${id}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                await loadChatHistory(); // Reload after deletion
            } else {
                console.error("Failed to delete message");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    async function updateMessage(id, newMessage) {
        try {
            const response = await fetch(`/chat/update/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: newMessage })
            });
            if (response.ok) {
                await loadChatHistory(); // Reload after update
            } else {
                console.error("Failed to update message");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }

    window.onload = loadChatHistory;
</script>

</body>
</html>
